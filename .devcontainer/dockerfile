# Use the latest version of Alpine Linux as the base image
FROM alpine:latest

# Define the version of KIND to be installed
ARG KIND_VERSION=0.18.0

# Install necessary packages and tools
RUN apk add --no-cache github-cli curl docker-cli git shadow sudo && \
    # Download and install kubectl
    curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl && \
    chmod +x ./kubectl && mv ./kubectl /usr/local/bin/kubectl && \
    # Download and install KIND
    curl -L https://github.com/kubernetes-sigs/kind/releases/download/v${KIND_VERSION}/kind-linux-amd64 -o /usr/local/bin/kind && \
    chmod +x /usr/local/bin/kind && \
    # Download and install Crossplane
    curl -sL "https://raw.githubusercontent.com/crossplane/crossplane/main/install.sh" | sh && mv crossplane /usr/local/bin && \
    # Clean up
    rm -rf /var/cache/apk/*

# Install other tools
RUN apk add --no-cache make helm

# ------------------------------------------------------
# Create non-root user "amine"
# ------------------------------------------------------
# shadow provides useradd/groupadd on Alpine
RUN groupadd -g 1000 amine && \
    useradd -m -s /bin/sh -u 1000 -g amine amine && \
    echo "amine ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Set working directory
WORKDIR /home/amine

# Switch to the non-root user by default
USER amine

# Ensure PATH includes local bin
ENV PATH="/home/amine/.local/bin:${PATH}"

